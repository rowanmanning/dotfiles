#!/usr/bin/env bash

startComment="
# ------------------------------------------------------------
# DO NOT EDIT ABOVE THIS LINE.
# Content is managed by chezmoi and may be overwritten.
"
endComment="
# DO NOT EDIT BELOW THIS LINE.
# Content is managed by chezmoi and may be overwritten.
# ------------------------------------------------------------
"

sshConfig="$(cat)"

# Prepend start comment if missing
if [[ "$sshConfig" != *"$startComment"* ]]; then
  sshConfig="${startComment}${sshConfig}"
fi

# Append end comment if missing
if [[ "$sshConfig" != *"$endComment"* ]]; then
  sshConfig="${sshConfig}${endComment}"
fi

# Extract content between startComment and endComment
customSshConfig="${sshConfig#*"$startComment"}"
customSshConfig="${customSshConfig%%"$endComment"*}"

tmp="${sshConfig#*"$startComment"}" # remove everything up to startComment
customSshConfig="${tmp%%"$endComment"*}" # remove everything after endComment

# Trim leading/trailing blank lines
customSshConfig="$(printf '%s' "$customSshConfig" | sed -e '1{/^[[:space:]]*$/d;}' -e '${/^[[:space:]]*$/d;}')"

cat <<EOF

Host github.com
  AddKeysToAgent yes
  UseKeychain yes
  IdentityFile ~/.ssh/git
${startComment}
${customSshConfig}
${endComment}
Host *
  AddKeysToAgent yes
  UseKeychain yes
  IdentityFile ~/.ssh/id_rsa
EOF
